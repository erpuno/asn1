defmodule SingleCrateGenerator do
  @moduledoc """
  Generates a single Rust crate with all ASN.1 types as separate .rs files in src/.
  Flat structure - no subdirectories. This completely eliminates circular dependency issues.
  """

  def generate_single_crate(_modules, output_dir) do
    IO.puts("\n=== Generating Single-Crate Structure ===")

    # Create directory structure
    src_dir = Path.join(output_dir, "src")
    File.mkdir_p!(src_dir)

    # Generate Cargo.toml for the single crate
    generate_cargo_toml(output_dir)

    # Generate lib.rs that declares all modules (discover from generated files)
    generate_lib_rs(src_dir)

    IO.puts("✓ Single crate structure created (flat - all types as separate files)")
  end

  defp generate_cargo_toml(output_dir) do
    content = """
    [package]
    name = "asn1_suite"
    version = "0.1.0"
    edition = "2024"

    [dependencies]
    rust-asn1 = { git = "https://github.com/iho/rust-asn1.git" }
    bytes = "1.0"
    chrono = "0.4"

    [dev-dependencies]
    reqwest = { version = "0.12", features = ["json"] }
    tokio = { version = "1", features = ["macros", "rt-multi-thread"] }
    sha2 = "0.10"
    p384 = "0.13"
    rand = "0.8"
    hmac = "0.12"
    """

    path = Path.join(output_dir, "Cargo.toml")
    File.write!(path, content)
    IO.puts("  ✓ Generated Cargo.toml")
  end

  defp generate_lib_rs(src_dir) do
    # Discover all .rs files in src_dir (flat structure)
    rs_files =
      Path.wildcard(Path.join(src_dir, "*.rs"))
      |> Enum.map(fn path -> Path.basename(path, ".rs") end)
      |> Enum.filter(fn name -> name != "lib" and name != "mod" end)
      |> Enum.sort()

    mod_declarations =
      rs_files
      |> Enum.map(fn mod_name -> "pub mod #{mod_name};\npub use #{mod_name}::*;" end)
      |> Enum.join("\n")

    content = """
    //! ASN.1 Suite - All types in one flat crate
    //! Generated by ASN1.ERP.UNO Compiler
    //!
    //! Flat structure eliminates all circular dependency issues.

    #![allow(non_snake_case)]
    #![allow(non_camel_case_types)]

    pub const PKCS9_UBNAME: i64 = 32768; // UB-name default value

    #{mod_declarations}
    """

    lib_path = Path.join(src_dir, "lib.rs")
    File.write!(lib_path, content)
    IO.puts("  ✓ Generated lib.rs with #{length(rs_files)} module declarations")
  end
end
